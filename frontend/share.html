<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Partager l'Application - Dénonciation RDC</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
</head>
<body class="auth-page">
    <div class="container">
        <div class="auth-modal" style="max-width: 800px;">
            <div class="auth-header">
                <div class="app-icon">
                    <i class="fas fa-globe"></i>
                </div>
                <h2>Partager l'Application</h2>
                <p>Statut d'accès pour les tests distants</p>
            </div>

            <div id="access-status" style="padding: 1rem; border-radius: 10px; margin: 1rem 0;">
                <h4><i class="fas fa-sync fa-spin"></i> Vérification de l'accès...</h4>
            </div>

            <div class="url-cards" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 2rem 0;">
                <div class="feature-card" id="local-card">
                    <i class="fas fa-wifi"></i>
                    <h4>Réseau Local</h4>
                    <p>Même WiFi que vous</p>
                    <input type="text" id="localUrl" readonly style="width: 100%; padding: 0.5rem; margin: 1rem 0; border: 1px solid #ddd; border-radius: 5px; font-size: 0.9rem;">
                    <button onclick="copyUrl('localUrl')" class="btn btn-primary">
                        <i class="fas fa-copy"></i> Copier
                    </button>
                </div>
                
                <div class="feature-card" id="public-card">
                    <i class="fas fa-globe"></i>
                    <h4>Accès Internet</h4>
                    <p>Depuis n'importe où</p>
                    <input type="text" id="publicUrl" readonly style="width: 100%; padding: 0.5rem; margin: 1rem 0; border: 1px solid #ddd; border-radius: 5px; font-size: 0.9rem;" placeholder="Configuration requise">
                    <button onclick="copyUrl('publicUrl')" class="btn btn-secondary" id="publicBtn" disabled>
                        <i class="fas fa-copy"></i> Copier
                    </button>
                </div>
            </div>

            <div id="vpn-instructions" style="display: none; background: #fff3cd; padding: 1.5rem; border-radius: 10px; margin: 1rem 0;">
                <h4><i class="fas fa-info-circle"></i> Pour l'Accès Distant</h4>
                <p><strong>Option 1 - VPN (Recommandé) :</strong></p>
                <ol>
                    <li>Téléchargez et installez un VPN (ZeroTier, Tailscale, etc.)</li>
                    <li>Créez un réseau et partagez-le avec les testeurs</li>
                    <li>Tous les appareils seront sur le même réseau virtuel</li>
                </ol>
                
                <p><strong>Option 2 - Ngrok (Simple) :</strong></p>
                <ol>
                    <li>Ouvrez un terminal dans le dossier backend</li>
                    <li>Exécutez : <code>npm install -g ngrok && ngrok http 3000</code></li>
                    <li>Partagez l'URL fournie par ngrok</li>
                </ol>

                <p><strong>Option 3 - Port Forwarding :</strong></p>
                <ol>
                    <li>Ouvrez les ports 3000 sur votre routeur</li>
                    <li>Partagez votre IP publique : <span id="public-ip">Chargement...</span></li>
                    <li>URL : <code id="public-ip-url">Chargement...</code></li>
                </ol>
            </div>

            <div class="qr-section" style="text-align: center; margin: 2rem 0; padding: 2rem; background: #f8f9fa; border-radius: 10px;">
                <h4><i class="fas fa-qrcode"></i> QR Code de Partage</h4>
                <div id="qrCode" style="margin: 1rem 0;"></div>
                <button onclick="downloadQRCode()" class="btn btn-secondary">
                    <i class="fas fa-download"></i> Télécharger QR Code
                </button>
            </div>

            <div class="auth-footer">
                <a href="/" class="btn btn-outline" style="color: #333; border-color: #333;">
                    <i class="fas fa-arrow-left"></i> Retour à l'application
                </a>
                <button onclick="location.reload()" class="btn btn-primary">
                    <i class="fas fa-sync"></i> Actualiser
                </button>
            </div>
        </div>
    </div>

    <script>
        async function loadShareInfo() {
            try {
                // Utiliser la route existante /api/network-info au lieu de /api/share-info
                const response = await fetch('/api/network-info');
                const data = await response.json();
                
                // Mettre à jour le statut
                const statusElement = document.getElementById('access-status');
                
                // Vérifier si nous avons des IPs réseau
                if (data.localIPs && data.localIPs.length > 0) {
                    statusElement.innerHTML = `
                        <div style="background: #d4edda; color: #155724; padding: 1rem; border-radius: 8px; border: 1px solid #c3e6cb;">
                            <h4><i class="fas fa-check-circle"></i> ✅ SERVEUR ACTIF</h4>
                            <p>L'application est accessible depuis votre réseau local!</p>
                            <p><strong>URL principale :</strong> ${data.primaryUrl}</p>
                        </div>
                    `;
                    
                    // Mettre à jour les URLs
                    document.getElementById('localUrl').value = data.primaryUrl;
                    
                    // Générer QR code avec URL principale
                    const qr = qrcode(0, 'M');
                    qr.addData(data.primaryUrl);
                    qr.make();
                    document.getElementById('qrCode').innerHTML = qr.createImgTag(4);
                    
                    // Afficher les instructions pour l'accès distant
                    document.getElementById('vpn-instructions').style.display = 'block';
                    
                } else {
                    statusElement.innerHTML = `
                        <div style="background: #fff3cd; color: #856404; padding: 1rem; border-radius: 8px; border: 1px solid #ffeaa7;">
                            <h4><i class="fas fa-exclamation-triangle"></i> ⚠️ ACCÈS LOCAL SEULEMENT</h4>
                            <p>L'application est démarrée mais l'accès réseau n'est pas détecté.</p>
                            <p>URL locale : ${data.urls[0]}</p>
                        </div>
                    `;
                    
                    document.getElementById('vpn-instructions').style.display = 'block';
                    
                    // Générer QR code avec URL locale
                    const qr = qrcode(0, 'M');
                    qr.addData(data.urls[0]);
                    qr.make();
                    document.getElementById('qrCode').innerHTML = qr.createImgTag(4);
                }
                
                // Afficher toutes les URLs disponibles
                console.log('URLs disponibles:', data.urls);
                
            } catch (error) {
                console.error('Erreur:', error);
                document.getElementById('access-status').innerHTML = `
                    <div style="background: #f8d7da; color: #721c24; padding: 1rem; border-radius: 8px; border: 1px solid #f5c6cb;">
                        <h4><i class="fas fa-times-circle"></i> ❌ ERREUR DE CONNEXION</h4>
                        <p>Impossible de contacter le serveur. Vérifiez que :</p>
                        <ul style="text-align: left; margin: 10px 0;">
                            <li>Le serveur est démarré sur le port 3000</li>
                            <li>Vous accédez à la bonne URL</li>
                            <li>Il n'y a pas de problème de firewall</li>
                        </ul>
                        <p><strong>Détail de l'erreur :</strong> ${error.message}</p>
                    </div>
                `;
            }
        }

        // Fonction pour obtenir l'IP publique
        async function getPublicIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                document.getElementById('public-ip').textContent = data.ip;
                document.getElementById('public-ip-url').textContent = `http://${data.ip}:3000`;
            } catch (error) {
                document.getElementById('public-ip').textContent = 'Impossible à obtenir';
                document.getElementById('public-ip-url').textContent = 'http://VOTRE-IP-PUBLIQUE:3000';
            }
        }

        function copyUrl(inputId) {
            const input = document.getElementById(inputId);
            input.select();
            document.execCommand('copy');
            alert('✅ URL copiée dans le presse-papier!');
        }

        function downloadQRCode() {
            const qrImg = document.querySelector('#qrCode img');
            if (qrImg) {
                const link = document.createElement('a');
                link.download = 'qr-code-dénonciation-rdc.png';
                link.href = qrImg.src;
                link.click();
            } else {
                alert('Générez d\'abord un QR code');
            }
        }

        // Charger au démarrage
        document.addEventListener('DOMContentLoaded', function() {
            loadShareInfo();
            getPublicIP();
        });
    </script>
</body>
</html>